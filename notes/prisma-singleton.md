Prisma 單例模式：https://bit.ly/4dHUMDc

讓我用簡單的方式來解釋這段程式碼！

# 給小學生的 prisma.ts 解釋 🌟

## 這是什麼？ 🤔

想像你有一個很大的玩具箱（資料庫），這段程式碼就像是一把鑰匙 🔑，讓我們可以打開玩具箱來存放或拿取玩具（資料）。

## 為什麼要這樣寫？ 🎯

```typescript:src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

// 1. 準備一個特別的口袋
const globalForPrisma = globalThis as unknown as { prisma: PrismaClient }

// 2. 檢查口袋裡有沒有鑰匙，沒有的話就做一把新的
export const prisma = globalForPrisma.prisma || new PrismaClient()

// 3. 如果不是正式使用時，就把鑰匙放在口袋裡
if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### 用生活例子來解釋 🏠

想像你和家人住在同一個房子：

1. **共用鑰匙原則**

   - 每個家庭只需要一把鑰匙就夠了
   - 不需要每個人都有一把鑰匙
   - 大家可以共用同一把鑰匙

2. **節省資源**

   - 如果每個人都有一把鑰匙（建立新的連線）
   - 會浪費資源（就像浪費金屬做很多把一樣的鑰匙）
   - 也可能造成混亂（太多人同時開門）

3. **安全檢查**
   - 在正式使用前，要確保鑰匙可以正常使用
   - 如果鑰匙壞了，要馬上換新的

## 為什麼這樣設計很棒？ 👍

1. **省資源**

   - 不會重複建立連線
   - 電腦會跑得更快

2. **好管理**

   - 所有程式都用同一個連線
   - 不會混亂

3. **安全可靠**
   - 確保資料庫連線正常運作
   - 不會發生連線太多的問題

這就像是大家一起分享同一把鑰匙，既方便又不浪費，還很安全！🎉

---

> 為什麼正式環境 production 無需共用鑰匙？這樣會不會一直重覆建立連線？

讓我解釋為什麼生產環境（production）的行為會不一樣！

# 生產環境的連線管理 🏭

## 開發環境 vs 生產環境的差異

### 開發環境（Development）👨‍💻

```typescript
// 在開發時，我們會這樣：
if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

- 開發時，程式碼會因為我們修改而**不斷重新載入**
- 每次重載都可能創建新的連線
- 所以需要把連線存在全局變量（globalForPrisma）中重複使用
- 避免開發時建立太多連線導致資料庫負擔過重

### 生產環境（Production）🚀

- 生產環境的程式碼是**穩定的**，不會一直重新載入
- 伺服器啟動時只會建立一次 PrismaClient
- Node.js 的模組系統會自動緩存 `prisma.ts` 的實例
- 所以不需要特別存在全局變量中

## 用餐廳來打比方 🍽️

### 開發環境就像：

- 餐廳在**試營運**
- 廚師一直在改菜單（程式碼修改）
- 需要一個特別的記事本（globalForPrisma）記錄目前的菜單狀態
- 避免每次改菜單就要重新打印所有菜單（避免重複建立連線）

### 生產環境就像：

- 餐廳**正式營業**
- 菜單已經確定（程式碼穩定）
- 不會一直改變
- 直接用印好的菜單就可以了（Node.js 模組緩存）

## 所以不會有重複連線的問題！ ✨

在生產環境中：

1. 伺服器啟動時建立一次 PrismaClient
2. Node.js 會自動重用這個實例
3. 不會重複建立新的連線
4. 效能反而更好！

這就是為什麼生產環境不需要特別的全局變量管理，系統會自動幫我們處理好這些事情！
